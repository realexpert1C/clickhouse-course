hw21
# –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Äî –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤

### –£—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞–Ω–∏—è
–∏–∑—É—á–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö;
–Ω–∞—É—á–∏—Ç—å—Å—è –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ª–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤;
–æ–≤–ª–∞–¥–µ—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ ClickHouse;

### –û–ø–∏—Å–∞–Ω–∏–µ/–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è:
1. –í–æ–∑—å–º–∏—Ç–µ –ª—é–±–æ–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π DATASET: https://clickhouse.com/docs/en/getting-started/example-datasets.
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞:
- –û–¥–∏–Ω —Å —É—Å–ª–æ–≤–∏–µ–º WHERE, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–º –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –¥—Ä—É–≥–æ–º—É —Å—Ç–æ–ª–±—Ü—É).
- –î—Ä—É–≥–æ–π —Å —É—Å–ª–æ–≤–∏–µ–º WHERE, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–º –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Å—Ç–æ–ª–±—Ü—É, —è–≤–ª—è—é—â–µ–º—É—Å—è PK).
3. –°—Ä–∞–≤–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ª–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤. –í—ã–¥–µ–ª–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –ø—Ä–æ–±–µ–≥—É –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –≤ –ª–æ–≥–∞—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É EXPLAIN –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ–∫–∞–∂–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –≤ –≤—ã–≤–æ–¥–µ.

–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏, —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ –ª–æ–≥–∞–º–∏ –∏ –≤—ã–≤–æ–¥–æ–º EXPLAIN.

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:
–ó–∞–¥–∞–Ω–∏–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º, –µ—Å–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ª–æ–≥–∏ –∏ –≤—ã–≤–æ–¥—ã EXPLAIN –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.

---

## –®–∞–≥ 1 ‚Äî –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞

–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–ª–∞—Å—Ç–µ—Ä:
- 1 shard
- 4 replicas: ch1, ch2, ch3, ch4
- Replication —á–µ—Ä–µ–∑ ClickHouse Keeper
- –¢–∞–±–ª–∏—Ü–∞ (–∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤) ReplicatedMergeTree:
- uk_price_paid_daily_repl

---
–ó–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–º –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞:
```sql
CREATE TABLE default.uk_price_paid_daily_repl
(
    `price` UInt32,
    `date` Date,
    `postcode1` LowCardinality(String),
    `postcode2` LowCardinality(String),
    `type` Enum8('other' = 0, 'terraced' = 1, 'semi-detached' = 2, 'detached' = 3, 'flat' = 4),
    `is_new` UInt8,
    `duration` Enum8('unknown' = 0, 'freehold' = 1, 'leasehold' = 2),
    `addr1` String,
    `addr2` String,
    `street` LowCardinality(String),
    `locality` LowCardinality(String),
    `town` LowCardinality(String),
    `district` LowCardinality(String),
    `county` LowCardinality(String)
)
ENGINE = ReplicatedMergeTree('/clickhouse/tables/{shard}/default/uk_price_paid_daily_repl', '{replica}')
PARTITION BY toYYYYMMDD(date)
ORDER BY (postcode1, postcode2, addr1, addr2)
SETTINGS index_granularity = 8192
```

–¢–∞–±–ª–∏—Ü–∞:

ENGINE = ReplicatedMergeTree
PARTITION BY toYYYYMMDD(date)
ORDER BY (postcode1, postcode2, addr1, addr2)

–í–∞–∂–Ω–æ:
* PRIMARY KEY = (postcode1, postcode2, addr1, addr2)
* date ‚Äî —ç—Ç–æ partition key, –Ω–æ –Ω–µ primary key
* –ò–Ω–¥–µ–∫—Å ‚Äî sparse (marks, granules –ø–æ 8192 —Å—Ç—Ä–æ–∫)

---

## –®–∞–≥ 2 ‚Äî –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤

### –ó–∞–ø—Ä–æ—Å –ë–ï–ó –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è primary key

```sql
SET send_logs_level = 'trace';

SELECT count()
FROM default.uk_price_paid_daily_repl
WHERE date = '2025-11-01'
FORMAT Null;
```

`date` –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ Primary Key, –ø–æ—ç—Ç–æ–º—É –∏–Ω–¥–µ–∫—Å –Ω–µ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.

---

–§—Ä–∞–≥–º–µ–Ω—Ç trace-–ª–æ–≥–∞
```bash
Key condition: unknown

PK index has dropped 0/151174 granules

Selected 3/3 parts by partition key,
3 parts by primary key,
151174/151174 marks by primary key,
151174 marks to read from 3 ranges

Read 1238404226 rows, 2.31 GiB
```
---

–ê–Ω–∞–ª–∏–∑:
*	Key condition: unknown ‚Äî Primary Key –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–º
* 151174/151174 marks ‚Äî –ø—Ä–æ—á–∏—Ç–∞–Ω—ã –≤—Å–µ –≥—Ä–∞–Ω—É–ª—ã
* –í—ã–ø–æ–ª–Ω–µ–Ω full scan
* –ü—Ä–æ—á–∏—Ç–∞–Ω–æ 1.24 –º–ª—Ä–¥ —Å—Ç—Ä–æ–∫

![–°–∫—Ä–∏–Ω—à–æ—Ç –ª–æ–≥–∞ –±–µ–∑ PK]()


EXPLAIN
```sql
EXPLAIN indexes = 1
SELECT count()
FROM default.uk_price_paid_daily_repl
WHERE date = '2025-11-01';
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç
```bash
Indexes:
  PrimaryKey
    Condition: true
    Parts: 3/3
    Granules: 151174/151174
```

![üì∏ EXPLAIN –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è PK:]()

---

### –ó–∞–ø—Ä–æ—Å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Primary Key

```sql
SET send_logs_level = 'trace';

SELECT count()
FROM default.uk_price_paid_daily_repl
WHERE postcode1 = 'SW1A'
FORMAT Null;
```

postcode1 ‚Äî –ø–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ Primary Key.

–§—Ä–∞–≥–º–µ–Ω—Ç trace-–ª–æ–≥–∞

![–°–∫—Ä–∏–Ω—à–æ—Ç –ª–æ–≥–∞ c PK]()

–ê–Ω–∞–ª–∏–∑

* Primary Key –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.
* –û—Ç–±—Ä–æ—à–µ–Ω–æ 151173 –∏–∑ 151174 –≥—Ä–∞–Ω—É–ª.
* –ü—Ä–æ—á–∏—Ç–∞–Ω–∞ 1 –≥—Ä–∞–Ω—É–ª–∞ (8192 —Å—Ç—Ä–æ–∫–∏).
* –í—ã–ø–æ–ª–Ω–µ–Ω range scan.
* –û–±—ä—ë–º —á—Ç–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –º–µ–Ω—å—à–µ

---

EXPLAIN
```sql
EXPLAIN indexes = 1
SELECT count()
FROM default.uk_price_paid_daily_repl
WHERE postcode1 = 'SW1A';
```
–û–∂–∏–¥–∞–µ–º—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç

```bash
Indexes:
PrimaryKey                                               
           Keys:                                                  
               postcode1                                            
             Condition: (postcode1 in ['SW1A', 'SW1A'])             
             Parts: 1/3                                             
             Granules: 1/151174

```

![üì∏ EXPLAIN c –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PK:]()

---

## –®–∞–≥ 3. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

```text
+-------------------+-------------------+---------------------+
| –ó–∞–ø—Ä–æ—Å            | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ PK  | –ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –≥—Ä–∞–Ω—É–ª—ã |
+-------------------+-------------------+---------------------+
| WHERE date        | –ù–µ—Ç               | 151174 / 151174     |
| WHERE postcode1   | –î–∞                | 1 / 151174          |
+-------------------+-------------------+---------------------+
```


Primary Key —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —É–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∏—Ç–∞–µ–º—ã—Ö –≥—Ä–∞–Ω—É–ª.


–ò—Ç–æ–≥–∏:
1.	–ó–∞–ø—Ä–æ—Å –ø–æ —Å—Ç–æ–ª–±—Ü—É, –Ω–µ –≤—Ö–æ–¥—è—â–µ–º—É –≤ Primary Key, –≤—ã–ø–æ–ª–Ω—è–µ—Ç full scan.
2.	–ó–∞–ø—Ä–æ—Å –ø–æ —Å—Ç–æ–ª–±—Ü—É Primary Key –≤—ã–ø–æ–ª–Ω—è–µ—Ç range scan.
3.	–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Primary Key —É–º–µ–Ω—å—à–∞–µ—Ç –æ–±—ä—ë–º —á—Ç–µ–Ω–∏—è –∏ –ø–æ–≤—ã—à–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞.