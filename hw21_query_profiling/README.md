hw21
# –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Äî –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤

### –£—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞–Ω–∏—è
–∏–∑—É—á–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö;
–Ω–∞—É—á–∏—Ç—å—Å—è –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ª–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤;
–æ–≤–ª–∞–¥–µ—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ ClickHouse;

### –û–ø–∏—Å–∞–Ω–∏–µ/–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è:
1. –í–æ–∑—å–º–∏—Ç–µ –ª—é–±–æ–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π DATASET: https://clickhouse.com/docs/en/getting-started/example-datasets.
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞:
- –û–¥–∏–Ω —Å —É—Å–ª–æ–≤–∏–µ–º WHERE, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–º –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –¥—Ä—É–≥–æ–º—É —Å—Ç–æ–ª–±—Ü—É).
- –î—Ä—É–≥–æ–π —Å —É—Å–ª–æ–≤–∏–µ–º WHERE, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–º –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Å—Ç–æ–ª–±—Ü—É, —è–≤–ª—è—é—â–µ–º—É—Å—è PK).
3. –°—Ä–∞–≤–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ª–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤. –í—ã–¥–µ–ª–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –ø—Ä–æ–±–µ–≥—É –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –≤ –ª–æ–≥–∞—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É EXPLAIN –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ–∫–∞–∂–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –≤ –≤—ã–≤–æ–¥–µ.

–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏, —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ –ª–æ–≥–∞–º–∏ –∏ –≤—ã–≤–æ–¥–æ–º EXPLAIN.

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:
–ó–∞–¥–∞–Ω–∏–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º, –µ—Å–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ª–æ–≥–∏ –∏ –≤—ã–≤–æ–¥—ã EXPLAIN –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.

---

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞

–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–ª–∞—Å—Ç–µ—Ä:
- 1 shard
- 4 replicas: ch1, ch2, ch3, ch4
- Replication —á–µ—Ä–µ–∑ ClickHouse Keeper
- –¢–∞–±–ª–∏—Ü–∞ (–∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤) ReplicatedMergeTree:
  - uk_price_paid_daily_repl

---
–ó–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–º –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞:
```sql
CREATE TABLE default.uk_price_paid_daily_repl
(
    `price` UInt32,
    `date` Date,
    `postcode1` LowCardinality(String),
    `postcode2` LowCardinality(String),
    `type` Enum8('other' = 0, 'terraced' = 1, 'semi-detached' = 2, 'detached' = 3, 'flat' = 4),
    `is_new` UInt8,
    `duration` Enum8('unknown' = 0, 'freehold' = 1, 'leasehold' = 2),
    `addr1` String,
    `addr2` String,
    `street` LowCardinality(String),
    `locality` LowCardinality(String),
    `town` LowCardinality(String),
    `district` LowCardinality(String),
    `county` LowCardinality(String)
)
ENGINE = ReplicatedMergeTree('/clickhouse/tables/{shard}/default/uk_price_paid_daily_repl', '{replica}')
PARTITION BY toYYYYMMDD(date)
ORDER BY (postcode1, postcode2, addr1, addr2)
SETTINGS index_granularity = 8192
```

–¢–∞–±–ª–∏—Ü–∞:

ENGINE = ReplicatedMergeTree
PARTITION BY toYYYYMMDD(date)
ORDER BY (postcode1, postcode2, addr1, addr2)

–í–∞–∂–Ω–æ:
* PRIMARY KEY = (postcode1, postcode2, addr1, addr2)
* date ‚Äî —ç—Ç–æ partition key, –Ω–æ –Ω–µ primary key
* –ò–Ω–¥–µ–∫—Å ‚Äî sparse (marks, granules –ø–æ 8192 —Å—Ç—Ä–æ–∫)

---

## –®–∞–≥ 1 ‚Äî –ó–∞–ø—Ä–æ—Å –ë–ï–ó –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è primary key

–ò—Å–ø–æ–ª—å–∑—É—é —Ñ–∏–ª—å—Ç—Ä –ø–æ date
(–æ–Ω —Ç–æ–ª—å–∫–æ partition pruning –¥–∞—Å—Ç, –Ω–æ –Ω–µ primary index range pruning)

```sql
SET send_logs_level = 'trace';

SELECT count()
FROM default.uk_price_paid_daily_repl
WHERE date = '2025-11-01'
FORMAT Null;
```


–û—Ç–ª–∏—á–Ω–æ. –ù–∏–∂–µ ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤—ã–π README.md, –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω—ã–π —Å—Ç—Ä–æ–≥–æ –ø–æ–¥ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É –∑–∞–¥–∞–Ω–∏—è, –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã.

–Ø –≤—Å—Ç–∞–≤–∏–ª:
	‚Ä¢	—á—ë—Ç–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
	‚Ä¢	—Ä–µ–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ —Ç–≤–æ–µ–≥–æ –ª–æ–≥–∞ (full scan)
	‚Ä¢	–º–µ—Ç–∫–∏, –≥–¥–µ –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã
	‚Ä¢	–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ –ª–æ–≥–∞–º–∏
	‚Ä¢	–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –¥–ª—è –∑–∞—á—ë—Ç–∞

‚∏ª

üìÑ README.md

# –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ: –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ ClickHouse

–ö–ª–∞—Å—Ç–µ—Ä: 1 shard, 4 replica  
–í–µ—Ä—Å–∏—è ClickHouse: 25.3 LTS  
–¢–∞–±–ª–∏—Ü–∞: default.uk_price_paid_daily_repl  
ENGINE: ReplicatedMergeTree  
PARTITION BY: toYYYYMMDD(date)  
ORDER BY (Primary Key): (postcode1, postcode2, addr1, addr2)

---

# 1. –ó–∞–ø—Ä–æ—Å –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Primary Key

## SQL-–∑–∞–ø—Ä–æ—Å

```sql
SET send_logs_level = 'trace';

SELECT count()
FROM default.uk_price_paid_daily_repl
WHERE date = '2025-11-01'
FORMAT Null;

date –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ Primary Key, –ø–æ—ç—Ç–æ–º—É –∏–Ω–¥–µ–∫—Å –Ω–µ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.

‚∏ª

–§—Ä–∞–≥–º–µ–Ω—Ç trace-–ª–æ–≥–∞

Key condition: unknown

PK index has dropped 0/151174 granules

Selected 3/3 parts by partition key,
3 parts by primary key,
151174/151174 marks by primary key,
151174 marks to read from 3 ranges

Read 1238404226 rows, 2.31 GiB


‚∏ª

–ê–Ω–∞–ª–∏–∑
	‚Ä¢	Key condition: unknown ‚Äî Primary Key –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–º
	‚Ä¢	151174/151174 marks ‚Äî –ø—Ä–æ—á–∏—Ç–∞–Ω—ã –≤—Å–µ –≥—Ä–∞–Ω—É–ª—ã
	‚Ä¢	–í—ã–ø–æ–ª–Ω–µ–Ω full scan
	‚Ä¢	–ü—Ä–æ—á–∏—Ç–∞–Ω–æ 1.24 –º–ª—Ä–¥ —Å—Ç—Ä–æ–∫

‚∏ª

–°–∫—Ä–∏–Ω—à–æ—Ç –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞

üì∏ –í—Å—Ç–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –±–ª–æ–∫–∞ —Å:

Selected 3/3 parts by partition key
151174/151174 marks by primary key


‚∏ª

EXPLAIN

EXPLAIN indexes = 1
SELECT count()
FROM default.uk_price_paid_daily_repl
WHERE date = '2025-11-01';

–û–∂–∏–¥–∞–µ–º—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç

Indexes:
  PrimaryKey
    Condition: true
    Parts: 3/3
    Granules: 151174/151174


‚∏ª

üì∏ –í—Å—Ç–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç EXPLAIN –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è PK:


‚∏ª

2. –ó–∞–ø—Ä–æ—Å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Primary Key

SQL-–∑–∞–ø—Ä–æ—Å

SET send_logs_level = 'trace';

SELECT count()
FROM default.uk_price_paid_daily_repl
WHERE postcode1 = 'SW1A'
FORMAT Null;

postcode1 ‚Äî –ø–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ Primary Key.

‚∏ª

–§—Ä–∞–≥–º–µ–Ω—Ç trace-–ª–æ–≥–∞

(–ø—Ä–∏–º–µ—Ä –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è)

Key condition: (postcode1 in ['SW1A'])

PK index has dropped 150000/151174 granules

Selected 3/3 parts by partition key,
3 parts by primary key,
120/151174 marks by primary key,
120 marks to read from 3 ranges


‚∏ª

–ê–Ω–∞–ª–∏–∑
	‚Ä¢	Primary Key –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
	‚Ä¢	–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å –≥—Ä–∞–Ω—É–ª –æ—Ç–±—Ä–æ—à–µ–Ω–∞
	‚Ä¢	–í—ã–ø–æ–ª–Ω–µ–Ω range scan
	‚Ä¢	–û–±—ä—ë–º —á—Ç–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –º–µ–Ω—å—à–µ

‚∏ª

–°–∫—Ä–∏–Ω—à–æ—Ç –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞

üì∏ –í—Å—Ç–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –±–ª–æ–∫–∞ —Å:

PK index has dropped ...
120/151174 marks by primary key


‚∏ª

EXPLAIN

EXPLAIN indexes = 1
SELECT count()
FROM default.uk_price_paid_daily_repl
WHERE postcode1 = 'SW1A';

–û–∂–∏–¥–∞–µ–º—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç

Indexes:
  PrimaryKey
    Condition: (postcode1 in ['SW1A'])
    Parts: 3/3
    Granules: 120/151174


‚∏ª

üì∏ –í—Å—Ç–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç EXPLAIN —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PK:


‚∏ª

3. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

–ó–∞–ø—Ä–æ—Å	–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ PK	–ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –≥—Ä–∞–Ω—É–ª—ã
WHERE date	–ù–µ—Ç	151174/151174
WHERE postcode1	–î–∞	120/151174

Primary Key —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —É–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∏—Ç–∞–µ–º—ã—Ö –≥—Ä–∞–Ω—É–ª.

‚∏ª

–ò—Ç–æ–≥
	1.	–ó–∞–ø—Ä–æ—Å –ø–æ —Å—Ç–æ–ª–±—Ü—É, –Ω–µ –≤—Ö–æ–¥—è—â–µ–º—É –≤ Primary Key, –≤—ã–ø–æ–ª–Ω—è–µ—Ç full scan.
	2.	–ó–∞–ø—Ä–æ—Å –ø–æ —Å—Ç–æ–ª–±—Ü—É Primary Key –≤—ã–ø–æ–ª–Ω—è–µ—Ç range scan.
	3.	–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Primary Key —É–º–µ–Ω—å—à–∞–µ—Ç –æ–±—ä—ë–º —á—Ç–µ–Ω–∏—è –∏ –ø–æ–≤—ã—à–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞.

---

# üìÅ –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å –ª–æ–≥–∏ –≤ GitHub

–ï—Å—Ç—å 2 —Å–ø–æ—Å–æ–±–∞:

---

## –í–∞—Ä–∏–∞–Ω—Ç 1 ‚Äî –°–∫—Ä–∏–Ω—à–æ—Ç—ã (–ø—Ä–æ—â–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:

README.md
/screenshots/
trace_no_pk.png
trace_with_pk.png
explain_no_pk.png
explain_with_pk.png

Markdown –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∂–µ—Ç –∏—Ö.

---

## –í–∞—Ä–∏–∞–Ω—Ç 2 ‚Äî –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –ª–æ–≥–æ–≤

–°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É:

/logs/
trace_no_pk.txt
trace_with_pk.txt

–í README –≤—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É:

```markdown
[–û—Ç–∫—Ä—ã—Ç—å trace –ª–æ–≥ –±–µ–∑ PK](logs/trace_no_pk.txt)

GitHub –æ—Ç–∫—Ä–æ–µ—Ç —Ñ–∞–π–ª –≤ –±—Ä–∞—É–∑–µ—Ä–µ.

‚∏ª

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ ‚Äú–≤—Å–ø–ª—ã–≤–∞–Ω–∏–µ‚Äù (collapse block)

–ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å —Ç–∞–∫:

<details>
<summary>Trace –ª–æ–≥ –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è PK</summary>

–í–°–¢–ê–í–ò–¢–¨_–õ–û–ì_–°–Æ–î–ê

</details>

–¢–æ–≥–¥–∞ –ª–æ–≥ –±—É–¥–µ—Ç —Å–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å—Å—è.

‚∏ª

–í–∞–∂–Ω–æ

–¢–µ–±–µ –æ—Å—Ç–∞–ª–æ—Å—å:
	1.	–ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥ –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (—Å postcode1)
	2.	–í—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è granules
	3.	–°–¥–µ–ª–∞—Ç—å 4 —Å–∫—Ä–∏–Ω—à–æ—Ç–∞

–ò —ç—Ç–æ –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏—è–º –æ—Ü–µ–Ω–∫–∏.

‚∏ª

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –ø—Ä–∏—à–ª–∏ –ª–æ–≥ –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, —è –≤—Å—Ç–∞–≤–ª—é —Ä–µ–∞–ª—å–Ω—ã–µ —á–∏—Å–ª–∞ –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä—É—é README –±–µ–∑ —à–∞–±–ª–æ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.