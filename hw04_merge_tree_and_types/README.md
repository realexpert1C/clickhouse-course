# üìö MergeTree –∏ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

## –¶–µ–ª–∏ –∑–∞–Ω—è—Ç–∏—è

- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å `Primary Key` –∏ `Partition Key`

---

## üîÅ MergeTree: –∫–æ–Ω—Ü–µ–ø—Ü–∏—è –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**MergeTree** ‚Äî —ç—Ç–æ —Å–µ–º–µ–π—Å—Ç–≤–æ –¥–≤–∏–∂–∫–æ–≤ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ ClickHouse, —Ä–µ–∞–ª–∏–∑—É—é—â–µ–µ —Ñ–æ–Ω–æ–≤–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö (Parts).

### üîß –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:
1. –î–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—É–ø–∞—é—Ç –≤ ClickHouse –∏ —Ä–∞–∑–±–∏–≤–∞—é—Ç—Å—è –Ω–∞ –±–ª–æ–∫–∏.
2. –°–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ `Primary Key`.
3. –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ `Part`.
4. –í —Ñ–æ–Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–ª–∏—è–Ω–∏–µ –±–ª–æ–∫–æ–≤ ‚Äî `Merge`.

### üß± –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Part:
- –ü—Ä–∏–º–µ—Ä –∏–º–µ–Ω–∏ Part: `20240101_1_1_0`
- –°–æ–¥–µ—Ä–∂–∏—Ç:
  - `primary.idx` ‚Äî –∏–Ω–¥–µ–∫—Å—ã –ø–æ `Primary Key`
  - `data.mrk3` ‚Äî –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –≥—Ä–∞–Ω—É–ª
  - `data.bin` ‚Äî —Å–∞–º–∏ –¥–∞–Ω–Ω—ã–µ

---

## üîç –ò–Ω–¥–µ–∫—Å—ã

### Primary Key (—Ä–∞–∑—Ä–µ–∂–µ–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å):
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `minmax` –∏–Ω–¥–µ–∫—Å (sparse index)
- –î–∞–Ω–Ω—ã–µ —Ä–∞–∑–±–∏–≤–∞—é—Ç—Å—è –Ω–∞ **–≥—Ä–∞–Ω—É–ª—ã** (`index_granularity`)
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–µ–∏–≤–∞—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–µ –±–ª–æ–∫–∏ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏

### Partition Key:
- –õ–æ–≥–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (—É–ø—Ä–æ—â–∞–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç merge)
- **–í–∞–∂–Ω–æ**: `Partition Key` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∏–Ω–¥–µ–∫—Å

---

## üßÆ –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

### –°—Ç—Ä–æ–∫–æ–≤—ã–µ:
- `String`, `FixedString(N)`

### –ß–∏—Å–ª–æ–≤—ã–µ:
- `UInt*`, `Int*`, `Float32/64`, `Decimal(P, S)`

### Bool –∏ Enum:
- `Bool`, `Enum`, `Enum16`

### –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:
- `Date`, `Date32`
- `DateTime`, `DateTime64`

### –°—Ç—Ä—É–∫—Ç—É—Ä—ã:
- `Array(T)`, `Tuple(...)`, `Map(K, V)`

### –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ:
- `Nested`, `AggregateFunction(...)`, `Point`, `IPv4`, `JSON`, `Interval`

---

## üí° Aliases —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö

- `VARCHAR`, `CHAR` ‚Üí `String`
- `BIGINT` ‚Üí `Int64`, `SMALLINT` ‚Üí `Int16`
- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ `system.data_type_families`

---

## üß™ Lightweight Delete (—Ñ–æ–Ω–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)

üîó –ò—Å—Ç–æ—á–Ω–∏–∫: [ClickHouse Lightweight Delete](https://clickhouse.com/docs/guides/developer/lightweight-delete)

### –ß—Ç–æ —ç—Ç–æ:
–ú–µ—Ö–∞–Ω–∏–∑–º –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫ –≤ ClickHouse. –í–º–µ—Å—Ç–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è, –¥–∞–Ω–Ω—ã–µ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∏ –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è –∏–∑ –∑–∞–ø—Ä–æ—Å–æ–≤.

### –ü—Ä–∏–Ω—Ü–∏–ø:
- –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Å–∫—Ä—ã—Ç—ã–π —Ñ–∏–ª—å—Ç—Ä –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –£–¥–∞–ª–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ –¥–∏—Å–∫–µ –¥–æ —Å–ª–∏—è–Ω–∏—è (merge)
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ –≤—Å–µ–≥–æ Part (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –æ–±—ã—á–Ω–æ–π –º—É—Ç–∞—Ü–∏–∏)

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- –£–¥–∞–ª–µ–Ω–∏–µ –ª–æ–≥–∏—á–µ—Å–∫–æ–µ ‚Äî –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –Ω–∞ –¥–∏—Å–∫–µ
- –¢—Ä–µ–±—É–µ—Ç Merge –¥–ª—è —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
- –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ç–∞–±–ª–∏—Ü (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ `MergeTree`)

### –ü—Ä–∏–º–µ—Ä:
```sql
ALTER TABLE events DELETE WHERE event_type = 'test';
```

## ‚úÖ –ò—Ç–æ–≥–∏
-	MergeTree —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ö—Ä–∞–Ω–∏—Ç –±–æ–ª—å—à–∏–µ –æ–±—ä–µ–º—ã –¥–∞–Ω–Ω—ã—Ö —Å —Ñ–æ–Ω–æ–≤—ã–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ–º.
- –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –Ω—É–∂–Ω–æ –ø–æ–¥–±–∏—Ä–∞—Ç—å –ø–æ –∑–∞–¥–∞—á–∞–º: –ø–æ –æ–±—ä–µ–º—É, —Å–∫–æ—Ä–æ—Å—Ç–∏, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.
- Lightweight Delete –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —É–¥–∞–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ Part-–æ–≤.

# üìä –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã ClickHouse –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞

–í ClickHouse –µ—Å—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –≤ –±–∞–∑–µ `system`, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞, –∑–∞–ø—Ä–æ—Å–∞—Ö, —Ä–µ—Å—É—Ä—Å–∞—Ö –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ.

## üîç –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

### `system.parts`
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏—è—Ö —Ç–∞–±–ª–∏—Ü.
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Å–∫–æ–≤ (parts), —Ä–∞–∑–º–µ—Ä, —Å—Ç–∞—Ç—É—Å.
- –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü.

### `system.merges`
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ —Ñ–æ–Ω–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–ª–∏—è–Ω–∏—è –∫—É—Å–∫–æ–≤ (merges).
- –í–∞–∂–Ω–æ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–≤–∏–∂–∫–∞ MergeTree.

### `system.replication_queue`
- –ê–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è —Ç–∞–±–ª–∏—Ü ReplicatedMergeTree.
- –°–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–¥–∞–Ω–∏—è –ø–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ä–µ–ø–ª–∏–∫, –∏—Ö —Å—Ç–∞—Ç—É—Å, –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –æ—à–∏–±–∫–∏.

### `system.replication_alter_columns_queue`
- –û—á–µ—Ä–µ–¥—å –æ–ø–µ—Ä–∞—Ü–∏–π `ALTER TABLE` –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ.
- –£–¥–æ–±–Ω–æ –ø—Ä–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º.

### `system.query_log`
- –õ–æ–≥ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é TTL 7 –¥–Ω–µ–π).
- –í–∫–ª—é—á–∞–µ—Ç:
  - –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞/–∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  - –¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞
  - –ö–æ–ª-–≤–æ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö/–∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –∏ –±–∞–π—Ç
  - –û—à–∏–±–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### `system.text_log` –∏ `system.trace_log`
- `text_log`: —Å–æ–æ–±—â–µ–Ω–∏—è –ª–æ–≥–≥–µ—Ä–∞ (—É—Ä–æ–≤–Ω–∏ INFO, WARNING, ERROR).
- `trace_log`: —Å—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤ (stack traces), –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏—è—Ö –∏ –¥–æ–ª–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è.

### `system.metric_log`
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π ClickHouse:
  - –ó–∞–≥—Ä—É–∑–∫–∞ CPU
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
  - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –º–µ—Ç—Ä–∏–∫–∞–º Prometheus.

### `system.processes`
- –ê–∫—Ç–∏–≤–Ω—ã–µ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å—ã.
- –ü–æ–ª—è: query_id, user, –∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞, —Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫/–±–∞–π—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ.

### `system.asynchronous_metrics`
- –ú–µ—Ç—Ä–∏–∫–∏, –æ–±–Ω–æ–≤–ª—è—é—â–∏–µ—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ —Ñ–æ–Ω–µ.
- –ü—Ä–∏–º–µ—Ä: usage of memory, page cache, disk I/O.

### `system.events`
- –°—á—ë—Ç—á–∏–∫–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π: —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—ã–∑–≤–∞–Ω insert, select, –∫–∞–∫–∏–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∏.
- –ú–æ–∂–Ω–æ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –∑–∞ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞.

## üõ† –ü—Ä–∏–º–µ—Ä—ã –ø–æ–ª–µ–∑–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:
```sql
SELECT query_id, query, elapsed, read_rows, memory_usage
FROM system.processes
ORDER BY elapsed DESC;
