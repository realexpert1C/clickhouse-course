# –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Ññ14 ‚Äî –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏–µ

---

### üìÑ –¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è

> –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏–µ  
>
> **–¶–µ–ª—å:**
> - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º—É—é;
> - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Ä–µ–ø–ª–∏–∫–∏ –≤ ClickHouse;
> - —Ä–∞–±–æ—Ç–∞—Ç—å —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ;
>
> **–û–ø–∏—Å–∞–Ω–∏–µ / —à–∞–≥–∏:**
> 1. –í–∑—è—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π dataset: https://clickhouse.com/docs/en/getting-started/example-datasets.
> 2. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º—É—é, –∏—Å–ø–æ–ª—å–∑—É—è –º–∞–∫—Ä–æ—Å `replica`.
> 3. –î–æ–±–∞–≤–∏—Ç—å 2 —Ä–µ–ø–ª–∏–∫–∏.
> 4. –í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∏ –æ—Ç–¥–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∫ 2 —Ñ–∞–π–ª–∞:
>    ```sql
>    SELECT getMacro('replica'), *
>    FROM remote('replica1,replica2,replica3', system.parts)
>    FORMAT JSONEachRow;
>
>    SELECT * FROM system.replicas
>    FORMAT JSONEachRow;
>    ```
> 5. –î–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É —Å —Ç–∏–ø–æ–º `Date` –≤ —Ç–∞–±–ª–∏—Ü–µ.
>    –î–æ–±–∞–≤–∏—Ç—å TTL –Ω–∞ —Ç–∞–±–ª–∏—Ü—É: —Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π.
> 6. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ `SHOW CREATE TABLE <—Ç–∞–±–ª–∏—Ü–∞>`.
>
> **–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:**
> - –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞;
> - –î–æ–±–∞–≤–ª–µ–Ω—ã —Ä–µ–ø–ª–∏–∫–∏;
> - –í—ã–ø–æ–ª–Ω–µ–Ω—ã –∑–∞–ø—Ä–æ—Å—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏;
> - –ù–∞—Å—Ç—Ä–æ–µ–Ω TTL —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π `SHOW CREATE TABLE`.

---

## üß© –≠—Ç–∞–ø 1 ‚Äî –ó–∞–ø—É—Å–∫ ClickHouse —Å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–µ–π

> –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω **docker‚Äëcompose**, —Å 3 —Ä–µ–ø–ª–∏–∫–∞–º–∏ ClickHouse:

```bash
docker compose up -d
```

### üìå clickhouse‚Äëclient –¥–æ—Å—Ç—É–ø –∫ –∫–∞–∂–¥–æ–º—É

```
# –†–µ–ø–ª–∏–∫–∞ 1
docker exec -it ch1 clickhouse-client

# –†–µ–ø–ª–∏–∫–∞ 2
docker exec -it ch2 clickhouse-client

# –†–µ–ø–ª–∏–∫–∞ 3
docker exec -it ch3 clickhouse-client
```

* * *

üß± –≠—Ç–∞–ø 2 ‚Äî –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º–æ–π —Ç–∞–±–ª–∏—Ü—ã
------------------------------------------

  

–ü—Ä–∏–º–µ—Ä: –≤–∑—è—Ç–∞ —Ç–∞–±–ª–∏—Ü–∞ events –∏–∑ –¥–µ–º–æ‚Äë–¥–∞—Ç–∞—Å–µ—Ç–∞.

  

### ‚ùó –°—Ö–µ–º–∞ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º–æ–π —Ç–∞–±–ª–∏—Ü—ã

```
CREATE TABLE default.events
(
    event_date Date,
    event_type String,
    user_id UInt64,
    session_id String,
    value Float32
)
ENGINE = ReplicatedMergeTree(
    '/clickhouse/tables/{layer}-{shard}/events',
    '{replica}'
)
PARTITION BY toYYYYMM(event_date)
ORDER BY (event_type, user_id)
TTL event_date + INTERVAL 7 DAY
SETTINGS
    index_granularity = 8192;
```

* * *

üéØ –≠—Ç–∞–ø 3 ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–ª–∏–∫
---------------------------

  

### üìå –ó–∞–ø—Ä–æ—Å —á–∞—Å—Ç–µ–π –Ω–∞ –≤—Å–µ—Ö —Ä–µ–ø–ª–∏–∫–∞—Ö

  

üìå –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ system\_parts.json:

```
SELECT getMacro('replica'), *
FROM remote('ch1, ch2, ch3', system.parts)
FORMAT JSONEachRow;
```

üíæ –°–∫—Ä–∏–Ω—à–æ—Ç / –≤—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:

(–∑–¥–µ—Å—å –≤—Å—Ç–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞)

* * *

### üìå –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ø–ª–∏–∫

  

üìå –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ system\_replicas.json:

```
SELECT *
FROM system.replicas
FORMAT JSONEachRow;
```

üíæ –°–∫—Ä–∏–Ω—à–æ—Ç / –≤—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:

(–∑–¥–µ—Å—å –≤—Å—Ç–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞)

* * *

üïê –≠—Ç–∞–ø 4 ‚Äî TTL
---------------

  

TTL –Ω–∞ —Ç–∞–±–ª–∏—Ü—É —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ DDL, –∏ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π.

  

–ß—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è ‚Äî –ø–æ—Å–º–æ—Ç—Ä–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç SHOW CREATE TABLE:

```
SHOW CREATE TABLE default.events;
```

### üìù –†–µ–∑—É–ª—å—Ç–∞—Ç

```
CREATE TABLE default.events
(
    event_date Date,
    event_type String,
    user_id UInt64,
    session_id String,
    value Float32
)
ENGINE = ReplicatedMergeTree(
    '/clickhouse/tables/{layer}-{shard}/events',
    '{replica}'
)
PARTITION BY toYYYYMM(event_date)
ORDER BY (event_type, user_id)
TTL event_date + INTERVAL 7 DAY
SETTINGS index_granularity = 8192
```

üíæ –°–∫—Ä–∏–Ω—à–æ—Ç DDL:

(–≤—Å—Ç–∞–≤–∏—Ç—å —Å—é–¥–∞)

* * *

‚úÖ –ò—Ç–æ–≥ –∏ –≤—ã–≤–æ–¥—ã
---------------

  

### üìå –ß–µ–º—É –Ω–∞—É—á–∏–ª—Å—è

  

‚úî –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ–º—É—é —Ç–∞–±–ª–∏—Ü—É –≤ ClickHouse

‚úî –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å 3 —Ä–µ–ø–ª–∏–∫–∏ —á–µ—Ä–µ–∑ –º–∞–∫—Ä–æ—Å {replica}

‚úî –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–∞—Å—Ç–∏ –∏ —Ä–µ–ø–ª–∏–∫–∏ —á–µ—Ä–µ–∑ system.parts –∏ system.replicas

‚úî –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å TTL, —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π

* * *

### üõ† –ö–∞–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –±—ã–ª–∏

  

‚ùó –ë—ã–ª–∏ –æ—à–∏–±–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –≤ ReplicatedMergeTree ‚Üí –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å ZooKeeper

‚ùó –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª remote() ‚Üí —Ä–µ—à–∏–ª —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–µ–ø–ª–∏–∫

* * *

### üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

  

–ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é: —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞, —Ä–µ–ø–ª–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, TTL –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω.

```
---
