## –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ: –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (EUDF) –≤ ClickHouse
#### –í–∞—Ä–∏–∞–Ω—Ç 2
---
### üîß 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ä–µ–¥—ã

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
sudo apt-get update
sudo apt-get install python3 python3-pip -y
pip3 install clickhouse-driver numpy pandas
```

__–ü–æ—è—Å–Ω–µ–Ω–∏—è__:

- __–ß—Ç–æ —Å–¥–µ–ª–∞–ª__: –£—Å—Ç–∞–Ω–æ–≤–∏–ª –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å Clickhouse Python –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å ClickHouse.

- __–ó–∞—á–µ–º__: –ë–µ–∑ Python-–æ–∫—Ä—É–∂–µ–Ω–∏—è EUDF —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥—É—Ç. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ clickhouse-driver –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–≤—è–∑—å –º–µ–∂–¥—É ClickHouse –∏ Python-—Å–∫—Ä–∏–ø—Ç–∞–º–∏.

- __–†–µ–∑—É–ª—å—Ç–∞—Ç__: –ì–æ—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Python-—Å–∫—Ä–∏–ø—Ç–æ–≤ –∏–∑ ClickHouse.

- __–ß–µ–º—É –Ω–∞—É—á–∏–ª—Å—è__: –í–∞–∂–Ω–æ—Å—Ç—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Å—Ä–µ–¥—ã –¥–ª—è –∏—Å–ø–æ–ª–Ω—è–µ–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏.
  
---

### ‚öôÔ∏è 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ClickHouse
```xml
<!-- /etc/clickhouse-server/user_functions.xml -->
<clickhouse>
    <user_defined_executable_functions_config>
        <allow_functions>true</allow_functions>
        <execution_path>/var/lib/clickhouse/udf</execution_path>
    </user_defined_executable_functions_config>
</clickhouse>
```

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è —Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ —Å–º–µ–Ω–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
sudo mkdir -p /var/lib/clickhouse/udf
sudo chown clickhouse:clickhouse /var/lib/clickhouse/udf
```

__–ü–æ—è—Å–Ω–µ–Ω–∏—è__:

- __–ß—Ç–æ —Å–¥–µ–ª–∞–ª__: –ù–∞—Å—Ç—Ä–æ–∏–ª ClickHouse –Ω–∞ —Ä–∞–±–æ—Ç—É —Å EUDF, —É–∫–∞–∑–∞–≤ –ø—É—Ç—å –¥–ª—è —Å–∫—Ä–∏–ø—Ç–æ–≤.

- __–ó–∞—á–µ–º__: –ë–µ–∑ —ç—Ç–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ClickHouse –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏.

- __–†–µ–∑—É–ª—å—Ç–∞—Ç__: –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏ –∏—Å–ø–æ–ª–Ω—è—Ç—å Python-—Å–∫—Ä–∏–ø—Ç—ã.

- __–ß–µ–º—É –Ω–∞—É—á–∏–ª—Å—è__: –ö–∞–∫ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤ –°–£–ë–î.
  
---

### üìù 3. –°–æ–∑–¥–∞–Ω–∏–µ UDF-—Å–∫—Ä–∏–ø—Ç–æ–≤

__–§–∞–π–ª 1__: `/var/lib/clickhouse/udf/total_price.py`

```python
import sys
import json

def calculate(quantity, price):
    return float(quantity * price)

if __name__ == "__main__":
    try:
        data = json.load(sys.stdin)
        result = calculate(data['quantity'], data['price'])
        print(json.dumps({"result": result}))
    except Exception as e:
        print(json.dumps({"error": str(e)}), file=sys.stderr)
        sys.exit(1)
```

__–ü–æ—è—Å–Ω–µ–Ω–∏—è__:

- __–ß—Ç–æ —Å–¥–µ–ª–∞–ª__: –°–æ–∑–¥–∞–ª —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

- __–ó–∞—á–µ–º__: –ß—Ç–æ–±—ã –≤—ã–Ω–µ—Å—Ç–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (—Ü–µ–Ω–∞ √ó –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ) –≤ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç.

- __–†–µ–∑—É–ª—å—Ç–∞—Ç__: –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –∏–∑ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤.

- __–ß–µ–º—É –Ω–∞—É—á–∏–ª—Å—è__: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å Python-–ª–æ–≥–∏–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å ClickHouse.

---

__–§–∞–π–ª 2__: `/var/lib/clickhouse/udf/transaction_category.py`

```python
import sys
import json

def categorize(total_price, threshold=100):
    return "High Value" if total_price > threshold else "Low Value"

if __name__ == "__main__":
    try:
        data = json.load(sys.stdin)
        result = categorize(data['total_price'], data.get('threshold', 100))
        print(json.dumps({"result": result}))
    except Exception as:
        print(json.dumps({"error": str(e)}), file=sys.stderr)
        sys.exit(1)
```

__–ü–æ—è—Å–Ω–µ–Ω–∏—è__:

- __–ß—Ç–æ —Å–¥–µ–ª–∞–ª__: –†–µ–∞–ª–∏–∑–æ–≤–∞–ª –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Ä–æ–≥–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è.

- __–ó–∞—á–µ–º__: –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —É—Å–ª–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏ –≤ EUDF –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.

- __–†–µ–∑—É–ª—å—Ç–∞—Ç__: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä—è–º–æ –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö.

- __–ß–µ–º—É –Ω–∞—É—á–∏–ª—Å—è__: –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (`threshold=100`).

---

### üõ†Ô∏è 4. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è UDF –≤ ClickHouse

```sql
-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏
CREATE FUNCTION total_price AS (quantity, price) -> 
    total_price(quantity, price) 
RETURNS Float32
ENGINE ExecutableScript(
    '/var/lib/clickhouse/udf/total_price.py', 
    'JSON'
);

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏
CREATE FUNCTION transaction_category AS (total_price, threshold) -> 
    transaction_category(total_price, threshold) 
RETURNS String
ENGINE ExecutableScript(
    '/var/lib/clickhouse/udf/transaction_category.py', 
    'JSON'
);
```
__–ü–æ—è—Å–Ω–µ–Ω–∏—è__:

- __–ß—Ç–æ —Å–¥–µ–ª–∞–ª__: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª Python-—Å–∫—Ä–∏–ø—Ç—ã –∫–∞–∫ SQL-—Ñ—É–Ω–∫—Ü–∏–∏.

- __–ó–∞—á–µ–º__: –ß—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ClickHouse.

- __–†–µ–∑—É–ª—å—Ç–∞—Ç__: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–∑—ã–≤–∞—Ç—å total_price() –∏ transaction_category() –≤ SQL.

- __–ß–µ–º—É –Ω–∞—É—á–∏–ª—Å—è__: –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤–Ω–µ—à–Ω–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤ —á–µ—Ä–µ–∑ ENGINE ExecutableScript.
  
---

### üí° 5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ UDF –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö
#### –ó–∞–ø—Ä–æ—Å 1: –†–∞—Å—á—ë—Ç –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏

```sql
SELECT 
    transaction_id,
    total_price(quantity, price) AS total
FROM transactions
LIMIT 10;
```

[—Å–º. —Å–∫—Ä–∏–Ω—à–æ—Ç](#)

__–ü–æ—è—Å–Ω–µ–Ω–∏—è__:

- __–ß—Ç–æ —Å–¥–µ–ª–∞–ª__: –ü—Ä–∏–º–µ–Ω–∏–ª EUDF –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

- __–ó–∞—á–µ–º__: –ß—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ä–∞–±–æ—Ç—É UDF –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

- __–†–µ–∑—É–ª—å—Ç–∞—Ç__: –¢–∞–±–ª–∏—Ü–∞ —Å ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Å—É–º–º–∞–º–∏.

- __–ß–µ–º—É –Ω–∞—É—á–∏–ª—Å—è__: –ö–∞–∫ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É –≤ SELECT-–∑–∞–ø—Ä–æ—Å—ã.

---

#### –ó–∞–ø—Ä–æ—Å 2: –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

```sql
SELECT
    transaction_id,
    total_price(quantity, price) AS total,
    transaction_category(total, 150) AS category
FROM transactions;
```

__–ü–æ—è—Å–Ω–µ–Ω–∏—è__:

- __–ß—Ç–æ —Å–¥–µ–ª–∞–ª__: –°–æ–≤–º–µ—Å—Ç–∏–ª –¥–≤–µ EUDF –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—É–º–º—ã –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏.

- __–ó–∞—á–µ–º__: –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–π –∏ —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.

- __–†–µ–∑—É–ª—å—Ç–∞—Ç__: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –º–µ—Ç–∫–∞–º–∏ "High Value"/"Low Value".

- __–ß–µ–º—É –Ω–∞—É—á–∏–ª—Å—è__: –¢–µ—Ö–Ω–∏–∫–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

---

### ‚úÖ 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

```sql
SELECT 
    transaction_category(250, 100) AS test_cat,
    total_price(5, 19.99) AS test_total
FORMAT Vertical
```

__–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥__:

```text
Row 1:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
test_cat:   High Value
test_total: 99.95
```

__–ü–æ—è—Å–Ω–µ–Ω–∏—è__:

- __–ß—Ç–æ —Å–¥–µ–ª–∞–ª__: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö.

- __–ó–∞—á–µ–º__: –ß—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ –∏ –ª–æ–≥–∏–∫–∏.

- __–†–µ–∑—É–ª—å—Ç–∞—Ç__: –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã UDF –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω–µ.

- __–ß–µ–º—É –Ω–∞—É—á–∏–ª—Å—è__: –ü–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –≤–∞–∂–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π.

---

### üöÄ –ò—Ç–æ–≥–æ–≤—ã–µ –≤—ã–≤–æ–¥—ã
1. __–ì–∏–±–∫–æ—Å—Ç—å EUDF__: –ü–æ–∑–≤–æ–ª—è—é—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª—é–±—É—é –ª–æ–≥–∏–∫—É –Ω–∞ Python, –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—É—é –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º SQL.

2. __–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å__: –¢—Ä–µ–±—É—é—Ç –∞–∫–∫—É—Ä–∞—Ç–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –º–æ–≥—É—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å –°–£–ë–î.

3. __–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å__:

- –°–∫—Ä–∏–ø—Ç—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏

- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ Python-–∫–æ–¥–µ

__–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ__:

- –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã

- –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ML-–º–æ–¥–µ–ª—è–º–∏

---

[–ü—Ä–∏–º–µ—Ä—ã —Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏] (https://github.com/yourname/clickhouse-eudf-example)