# –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Ññ 16 - –ú—É—Ç–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ —Å –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏

### üìÑ –¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è

> –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
>
> **–¶–µ–ª—å:**
> - –ø–æ–Ω—è—Ç—å, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –º—É—Ç–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ ClickHouse;
> - –Ω–∞—É—á–∏—Ç—å—Å—è —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ —Ç–∞–±–ª–∏—Ü –∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –Ω–∏–º–∏;
>
> **–û–ø–∏—Å–∞–Ω–∏–µ / —à–∞–≥–∏:**
> 1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É user_activity —Å –ø–æ–ª—è–º–∏:
> - user_id (UInt32) ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
> - activity_type (String) ‚Äî —Ç–∏–ø –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'login', 'logout', 'purchase')
> - activity_date (DateTime) ‚Äî –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
> - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ MergeTree –∫–∞–∫ –¥–≤–∏–∂–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –¥–∞—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (activity_date).
> 2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É:
> - –í—Å—Ç–∞–≤—å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü—É user_activity
> - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–ª–∏—á–Ω—ã–µ user_id, activity_type –∏ activity_date
> 3. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º—É—Ç–∞—Ü–∏–π:
> - –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º—É—Ç–∞—Ü–∏—é –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è(-–µ–π)
> 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:
> - –ù–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ç–∞–±–ª–∏—Ü–µ user_activity
> - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–∏–ø –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑–º–µ–Ω–∏–ª—Å—è
> - –ü—Ä–∏–ª–æ–∂–∏—Ç–µ –ª–æ–≥–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –º—É—Ç–∞—Ü–∏–π –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
> 5. –ú–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ —Å –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏:
> - –£–¥–∞–ª–∏—Ç–µ –ø–∞—Ä—Ç–∏—Ü–∏—é –∑–∞ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –º–µ—Å—è—Ü
> 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã:
> - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–∏
> - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã
>
> 7. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è (–ø–æ –∂–µ–ª–∞–Ω–∏—é):
> - –ò—Å—Å–ª–µ–¥—É–π—Ç–µ, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã –º—É—Ç–∞—Ü–∏–π.
> - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–∞—Ä—Ç–∏—Ü–∏—é –∏ –≤—Å—Ç–∞–≤–∏—Ç—å –≤ –Ω–µ—ë –¥–∞–Ω–Ω—ã–µ.
> - –ò–∑—É—á–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è TTL (Time to Live) –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π.
> 
> 
> **–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:**
>
>–ó–∞–¥–∞–Ω–∏–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º, –µ—Å–ª–∏ —Å–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º, –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –º—É—Ç–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è, —É–¥–∞–ª–µ–Ω–∞ –ø–∞—Ä—Ç–∏—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.

---

### –®–∞–≥ 1 - –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã user_activity

–°–æ–∑–¥–∞—é —Ç–∞–±–ª–∏—Ü—É —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –¥–≤–∏–∂–∫–∞ MergeTree, –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –¥–∞—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ activity_date.

```sql
CREATE TABLE default.user_activity
(
    user_id UInt32,
    activity_type String,
    activity_date DateTime
)
ENGINE = MergeTree
PARTITION BY toYYYYMM(activity_date)
ORDER BY (user_id, activity_date);
```

‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `SHOW CREATE TABLE user_activity;`.
![hw16_create_tbl](https://github.com/realexpert1C/clickhouse-course/blob/a57fa07f7267814db03eaca47b265e12a33d9952/images/hw16_create_tbl.png)

---

### –®–∞–≥ 2 - –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã

–í—Å—Ç–∞–≤–ª—è—é —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è–º–∏:

```sql
INSERT INTO default.user_activity VALUES 
(1, 'login', '2025-12-01 10:00:00'),
(1, 'logout', '2025-12-01 11:00:00'),
(2, 'purchase', '2025-12-02 15:00:00'),
(3, 'login', '2025-11-15 08:30:00'),
(3, 'purchase', '2025-11-16 09:00:00');
```
‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ `SELECT * FROM user_activity ORDER BY activity_date;`.
![hw16_insert_tbl](https://github.com/realexpert1C/clickhouse-course/blob/a57fa07f7267814db03eaca47b265e12a33d9952/images/hw16_insert_tbl.png)

---

### –®–∞–≥ 3 - –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º—É—Ç–∞—Ü–∏–∏

–ü–æ–º–µ–Ω—è—é —Ç–∏–ø –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å `login` –Ω–∞ `signin`:

```sql
ALTER TABLE default.user_activity
UPDATE activity_type = 'signin'
WHERE activity_type = 'login';
```

‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç: `SELECT * FROM user_activity WHERE activity_type = 'signin';`.
![hw16_alter_tbl](https://github.com/realexpert1C/clickhouse-course/blob/a57fa07f7267814db03eaca47b265e12a33d9952/images/hw16_alter_tbl.png)

---

### –®–∞–≥ 4 - –ü—Ä–æ–≤–µ—Ä–∫–∞ –º—É—Ç–∞—Ü–∏–∏

–ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

```sql
SELECT database, table, mutation_id, command, is_done, latest_failed_part
FROM system.mutations
WHERE table = 'user_activity';
```

‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ `system.mutations`.
![hw16_system_mutations](https://github.com/realexpert1C/clickhouse-course/blob/a57fa07f7267814db03eaca47b265e12a33d9952/images/hw16_system_mutations.png)

---

### –®–∞–≥ 5 - –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏

–ü—Ä–æ–≤–µ—Ä—è—é —Å–ø–∏—Å–æ–∫ –ø–∞—Ä—Ç–∏—Ü–∏–π –¥–æ —É–¥–∞–ª–µ–Ω–∏—è:

```sql
SELECT partition, min_date, max_date, rows
FROM system.parts
WHERE table = 'user_activity' AND active;
```

‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç: `system.parts` –¥–æ —É–¥–∞–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–∏ 202511.
![hw16_system_parts_before](https://github.com/realexpert1C/clickhouse-course/blob/a57fa07f7267814db03eaca47b265e12a33d9952/images/hw16_system_parts_before.png)

–£–¥–∞–ª—è—é –ø–∞—Ä—Ç–∏—Ü–∏—é –∑–∞ –Ω–æ—è–±—Ä—å 2025 (202511):

```sql
ALTER TABLE default.user_activity
DROP PARTITION 202511;
```

‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç: —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã `SELECT * FROM user_activity` –¥–æ –∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–∏.
![hw16_user_before_del_part](https://github.com/realexpert1C/clickhouse-course/blob/a57fa07f7267814db03eaca47b265e12a33d9952/images/hw16_user_before_del_part.png)
![hw16_user_after_del_part](https://github.com/realexpert1C/clickhouse-course/blob/a57fa07f7267814db03eaca47b265e12a33d9952/images/hw16_user_after_del_part.png)

---

### –®–∞–≥ 6 - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã

–ü—Ä–æ–≤–µ—Ä—è—é —Å–ø–∏—Å–æ–∫ –ø–∞—Ä—Ç–∏—Ü–∏–π:

```sql
SELECT partition, min_date, max_date, rows
FROM system.parts
WHERE table = 'user_activity' AND active;
```

‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–∏ 202511.
![hw16_system_parts_after](https://github.com/realexpert1C/clickhouse-course/blob/a57fa07f7267814db03eaca47b265e12a33d9952/images/hw16_system_parts_after.png)

---

### 7. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ —Ç–µ–º–µ –º—É—Ç–∞—Ü–∏–π –∏ —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ –≤ ClickHouse.

---

#### üîÑ 7.1. –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –º—É—Ç–∞—Ü–∏–π



---

#### üì¶ 7.2. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏ –∏ –≤—Å—Ç–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö

–î–æ–±–∞–≤–ª—è—é –¥–∞–Ω–Ω—ã–µ —Å –Ω–æ–≤–æ–π –¥–∞—Ç–æ–π, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—É—é –ø–∞—Ä—Ç–∏—Ü–∏—é (202601):

```sql
INSERT INTO default.user_activity VALUES 
(4, 'login', '2026-01-01 10:00:00'),
(5, 'purchase', '2026-01-01 12:00:00');
```

–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π:

```sql
SELECT DISTINCT partition
FROM system.parts
WHERE table = 'user_activity';
```

‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞–ª–∏—á–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–∏ 202601.

---

#### ‚è≥ 7.3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TTL –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–°–æ–∑–¥–∞–¥–∞—é —Ç–∞–±–ª–∏—Ü—É —Å TTL: —É–¥–∞–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ 15 –¥–Ω–µ–π –ø–æ—Å–ª–µ activity_date.

```sql
CREATE TABLE default.user_activity_ttl
(
    user_id UInt32,
    activity_type String,
    activity_date DateTime
)
ENGINE = MergeTree
PARTITION BY toYYYYMM(activity_date)
ORDER BY (user_id, activity_date)
TTL activity_date + INTERVAL 15 DAY;
```

–í—Å—Ç–∞–≤–ª—è—é —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ:

```sql
INSERT INTO default.user_activity_ttl VALUES 
(6, 'login', '2025-11-01 10:00:00'),
(7, 'logout', '2025-11-02 10:00:00');
```

–ü—Ä–æ–≤–µ—Ä—è—é, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ–Ω–µ merge.

–ü—Ä–æ–≤–µ—Ä–∫–∞ TTL:

```sql
SELECT table, name, ttl_expression, ttl_info
FROM system.columns
WHERE table = 'user_activity_ttl';
```

‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç: `SELECT * FROM user_activity_ttl` –¥–æ –∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏.

---
## –í—ã–≤–æ–¥—ã
