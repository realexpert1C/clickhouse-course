# –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Ññ 15 - –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ

### üìÑ –¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è

> –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
>
> **–¶–µ–ª—å:**
> - —à–∞—Ä–¥–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π –∏–Ω—Å—Ç–∞–Ω—Å;
>
> **–û–ø–∏—Å–∞–Ω–∏–µ / —à–∞–≥–∏:**
> 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ N —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ clickhouse-server.
> 2. –û–ø–∏—à–∏—Ç–µ –¥–≤–µ –∏–ª–∏ –±–æ–ª–µ–µ —Ç–æ–ø–æ–ª–æ–≥–∏–π –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –≤ —à–∞—Ä–¥—ã, —É–∫–∞–∑–∞–≤ —Ñ–∞–∫—Ç–æ—Ä —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞—Ä–¥–æ–≤.
> 3. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ xml-—Å–µ–∫—Ü–∏—é –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ñ–∞–π–ª–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
> 4. —Å–æ–∑–¥–∞—Ç—å DISTRIBUTED-—Ç–∞–±–ª–∏—Ü—É –Ω–∞ –∫–∞–∂–¥—É—é –∏–∑ —Ç–æ–ø–æ–ª–æ–≥–∏–π. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—É—é —Ç–∞–±–ª–∏—Ü—É system.one —Å–æ–¥–µ—Ä–∂–∞—â—É—é –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É dummy —Ç–∏–ø–∞ UInt8, –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã.
>    ```sql
>    SELECT getMacro('replica'), *
>    FROM remote('replica1,replica2,replica3', system.parts)
>    FORMAT JSONEachRow;
>
>    SELECT * FROM system.replicas
>    FORMAT JSONEachRow;
>    ```
>–∏–ª–∏ 5. –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤—ã–≤–æ–¥ –∑–∞–ø—Ä–æ—Å–∞ SELECT *,hostName(),_shard_num from distributed-table –¥–ª—è –∫–∞–∂–¥–æ–π distributed-—Ç–∞–±–ª–∏—Ü—ã, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å group by –∏ limit –ø–æ –≤–∫—É—Å—É –µ—Å–ª–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –º–Ω–æ–≥–æ.
>   
> –∏–ª–∏ 5. –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å SELECT * FROM system.clusters; SHOW CREATE TABLE –¥–ª—è –∫–∞–∂–¥–æ–π Distributed-—Ç–∞–±–ª–∏—Ü—ã.
>
> **–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:**
> –ó–∞–¥–∞–Ω–∏–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —ç–∫–∑–µ–º–ø–ª—è—Ä—ã ClickHouse, —Å–æ–∑–¥–∞–Ω—ã —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã DISTRIBUTED-—Ç–∞–±–ª–∏—Ü—ã –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
>

---

## –®–ê–ì 1 –ó–∞–ø—É—Å—Ç–∏—Ç–µ N —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ clickhouse-server.

–ù–∞ –¥–∞–Ω–Ω–æ–º —ç—Ç–∞–ø–µ —è –≤–æ—Å–ø–æ–ª—å–∑—É—é—Å—å —Ç—Ä–µ–º—è –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏ Clickhouse-server, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∑–∞–¥–∞–Ω–∏–∏, –∞ –∏–º–µ–Ω–Ω–æ ch1, ch2, ch3, –∞ —Ç–∞–∫–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª—é —á–µ—Ç–≤–µ—Ä—Ç—ã–π - ch4. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ä–≤–µ—Ä–æ–≤ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—Å—è —Ç–æ–ø–æ–ª–æ–≥–∏—è–º–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –≤ —à–∞—Ä–¥—ã. –ü–æ—á–µ–º—É –±—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ —á–µ—Ç—ã—Ä–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ - –ø–æ—è—Å–Ω—é –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ.

---

üîπ –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ –Ω–æ–¥—ã ch4, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤–æ –≤—Å–µ—Ö —Ç—Ä—ë—Ö –Ω–æ–≤—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞—Ö:

‚ùó–ó–∞—á–µ–º –Ω—É–∂–Ω–∞ ch4:
* –í –∫–ª–∞—Å—Ç–µ—Ä–µ replicated_cluster: –∫–∞–∫ 4-—è —Ä–µ–ø–ª–∏–∫–∞ –æ–¥–Ω–æ–≥–æ —à–∞—Ä–¥–∞
* –í –∫–ª–∞—Å—Ç–µ—Ä–µ sharded_cluster: –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —à–∞—Ä–¥
* –í –∫–ª–∞—Å—Ç–µ—Ä–µ main_cluster: –∫–∞–∫ —Ä–µ–ø–ª–∏–∫–∞ –≤—Ç–æ—Ä–æ–≥–æ —à–∞—Ä–¥–∞

---

### 1.1 –°–æ–∑–¥–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ch4
* –ò—Å–ø–æ–ª—å–∑—É—é –æ–±—Ä–∞–∑ clickhouse/clickhouse-server:25.3
* –ù–∞–∑–Ω–∞—á–∞—é —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—ã:
8126:8123, 9011:9000
* –ü—Ä–æ–ø–∏—Å—ã–≤–∞—é volume –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ config.d –∏ data
–°–æ–∑–¥–∞—é –∫–∞—Ç–∞–ª–æ–≥:

`infra/ch-cluster/ch4`

–∏ –≤ –Ω–µ–º —Ñ–∞–π–ª
__docker-compose.yaml__ (–∞–Ω–∞–ª–æ–≥–∏—á–µ–Ω ch1, –Ω–æ —Å –¥—Ä—É–≥–∏–º–∏ –ø–æ—Ä—Ç–∞–º–∏):

```yaml
services:
  ch4:
    image: clickhouse/clickhouse-server:25.3
    container_name: ch4
    hostname: ch4

    ports:
      - "8126:8123"
      - "9011:9000"

    volumes:
      - ./data:/var/lib/clickhouse
      - ./config.d:/etc/clickhouse-server/config.d

    networks:
      - infra-net

networks:
  infra-net:
    external: true
```
---

### 1.2 –ü–æ–¥–∫–ª—é—á–∞—é ch4 –∫ Keeper 
–°–æ–∑–¥–∞—é config.d/zookeeper.xml –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Keeper –Ω–∞ ch1:
```xml
<clickhouse>
  <zookeeper>
    <node>
      <host>ch1</host>
      <port>9181</port>
    </node>
  </zookeeper>
</clickhouse>
```

### 1.3 –ü—Ä–æ–ø–∏—Å—ã–≤–∞—é macros.xml –¥–ª—è ch4:
–ù–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–ø–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é —ç—Ç—É –Ω–æ–¥—É –∫–∞–∫ —Ä–µ–ø–ª–∏–∫—É –∫ ch1
```xml
<clickhouse>
  <macros>
    <!-- –ú–µ–Ω—è–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–ø–æ–ª–æ–≥–∏–∏ -->
    <shard>01</shard>
    <replica>ch4</replica>
  </macros>
</clickhouse>
```

üìå –ú–∞–∫—Ä–æ—Å—ã –Ω—É–∂–Ω—ã –¥–ª—è ReplicatedMergeTree –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–∏ –∫ Keeper.

### 1.4 –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é –ø–∞—Ä–æ–ª—å default:

–°–æ–∑–¥–∞—é users.d/default_password.xml:
```xml
<clickhouse>
  <users>
    <default>
      <password>default123</password>
    </default>
  </users>
</clickhouse>
```

### 1.5 –ó–∞–ø—É—Å–∫–∞—é ch4

```bash
docker compose up -d
```

–ü—Ä–æ–≤–µ—Ä—è—é, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–¥–Ω—è—Ç –∏ –∫–ª–∏–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç:

```bash
docker exec -it ch4 clickhouse-client
```

–ü—Ä–æ–≤–µ—Ä–∫–∞:
```sql
SELECT version(), uptime();
SELECT getMacro('shard'), getMacro('replica');
```

–°–∫—Ä–∏–Ω—à–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞
![hw15_ch4_check]()

## –®–∞–≥ 2 - –û–ø–∏—à–∏—Ç–µ –¥–≤–µ –∏–ª–∏ –±–æ–ª–µ–µ —Ç–æ–ø–æ–ª–æ–≥–∏–π –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –≤ —à–∞—Ä–¥—ã, —É–∫–∞–∑–∞–≤ —Ñ–∞–∫—Ç–æ—Ä —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞—Ä–¥–æ–≤

–û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä—ë—Ö —Ç–æ–ø–æ–ª–æ–≥–∏–π —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏:

---

|–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–ø–æ–ª–æ–≥–∏–∏|–ö–æ–ª-–≤–æ —à–∞—Ä–¥–æ–≤|–§–∞–∫—Ç–æ—Ä —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏|–í—Å–µ–≥–æ –Ω–æ–¥|–°–æ—Å—Ç–∞–≤|–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ|–ö–ª—é—á —Å—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏—è|
|------------------|-------------|-----------------|---------|------|----------|------------------|
|replicated_cluster|1|4|4|ch1, ch2, ch3, ch4|Full Replication|–ù–µ—Ç (–≤–æ–∑–º–æ–∂–Ω–æ, SAMPLE BY rand())|
|sharded_cluster|4|1|4|ch1, ch2, ch3, ch4|Full Sharding (–ø–æ —Ö–æ—Å—Ç–∞–º)|–û–±—è–∑–∞—Ç–µ–ª–µ–Ω, –Ω–∞–ø—Ä–∏–º–µ—Ä: SAMPLE BY rand()|
|main_cluster|2|2|4|–®–∞—Ä–¥1: ch1, ch3; –®–∞—Ä–¥2: ch2, ch4|–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ö–µ–º–∞|–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è, –Ω–∞–ø—Ä–∏–º–µ—Ä: SAMPLE BY id|

---

üî∏ –ü–æ—è—Å–Ω–µ–Ω–∏–µ –ø–æ –∫–∞–∂–¥–æ–π —Ç–æ–ø–æ–ª–æ–≥–∏–∏:

#### ‚úÖ 1. `replicated_cluster` ‚Äî ¬´–≤—Å–µ –Ω–æ–¥—ã –∫–∞–∫ —Ä–µ–ø–ª–∏–∫–∏ –æ–¥–Ω–æ–≥–æ —à–∞—Ä–¥–∞¬ª
- –í—Å–µ 4 –Ω–æ–¥—ã (ch1‚Äìch4) —è–≤–ª—è—é—Ç—Å—è —Ä–µ–ø–ª–∏–∫–∞–º–∏ –æ–¥–Ω–æ–≥–æ —à–∞—Ä–¥–∞
- –¢–∞–±–ª–∏—Ü—ã –Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ `ReplicatedMergeTree`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
	 * –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏
	 * –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —á—Ç–µ–Ω–∏—é
	 * –ú–∏–Ω—É—Å—ã: –Ω–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –∑–∞–ø–∏—Å–∏, –≤—Å—ë –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è

üìå –ö–∞–∫ –Ω–∞ —Å–ª–∞–π–¥–µ ¬´All Replicated¬ª –∏–∑ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ Altinity [—Å—Ç—Ä. 10]() Ôøº

---

#### ‚úÖ 2. `sharded_cluster` ‚Äî ¬´–∫–∞–∂–¥–∞—è –Ω–æ–¥–∞ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π —à–∞—Ä–¥¬ª
- ch1‚Äìch4 = 4 –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö —à–∞—Ä–¥–∞, –±–µ–∑ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
- –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –¥–∞–Ω–Ω—ã–º
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Distributed-—Ç–∞–±–ª–∏—Ü–∞, –∫–æ—Ç–æ—Ä–∞—è –ø–æ —à–∞—Ä–¥-–∫–ª—é—á—É (rand() –∏–ª–∏ id) —Ä–∞—Å–∫–∏–¥—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –Ω–æ–¥–∞–º
- –¢–∞–±–ª–∏—Ü—ã MergeTree ‚Äî –±–µ–∑ ReplicatedMergeTree
- –í–∞–∂–Ω–æ: –Ω—É–∂–µ–Ω SAMPLE BY, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º max_parallel_replicas > 1 [—Å–º. —Å–ª–∞–π–¥ 43 Altinity]() Ôøº

---

#### ‚úÖ 3. `main_cluster` ‚Äî ¬´2 —à–∞—Ä–¥–∞, –≤ –∫–∞–∂–¥–æ–º –ø–æ 2 —Ä–µ–ø–ª–∏–∫–∏¬ª
- –®–∞—Ä–¥ 1: ch1 (–æ—Å–Ω–æ–≤–Ω–∞—è), ch3 (—Ä–µ–ø–ª–∏–∫–∞)
- –®–∞—Ä–¥ 2: ch2 (–æ—Å–Ω–æ–≤–Ω–∞—è), ch4 (—Ä–µ–ø–ª–∏–∫–∞)
- –≠—Ç–æ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –±–æ–µ–≤–∞—è —Å—Ö–µ–º–∞ —Å –±–∞–ª–∞–Ω—Å–æ–º –º–µ–∂–¥—É –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å—é –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- ReplicatedMergeTree + Distributed
- –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω–æ –¥–ª—è –ø—Ä–æ–¥-–æ–∫—Ä—É–∂–µ–Ω–∏–π
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç max_parallel_replicas –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ SAMPLE BY

üìå –ö–∞–∫ –Ω–∞ —Å–ª–∞–π–¥–µ ¬´Sharded and Replicated¬ª –∏–∑ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ Altinity [—Å—Ç—Ä. 10]() Ôøº

---

