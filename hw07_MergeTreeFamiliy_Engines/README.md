## –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ: "–î–≤–∏–∂–∫–∏ MergeTree Family"

### –¶–µ–ª—å
1. –ü–æ –∑–∞–¥–∞–Ω–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏—è–º —Ç–∞–±–ª–∏—Ü –∏ –≤—Å—Ç–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å
–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –¥–≤–∏–∂–æ–∫
1. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–ø—É—Å–∫–∏, –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–¥
2. –°—Ä–∞–≤–Ω–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –≤—ã–≤–æ–¥ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ —É—Å–ª–æ–≤–∏—è

---

#### –ó–∞–¥–∞–Ω–∏–µ 1: –¢–∞–±–ª–∏—Ü–∞ tbl1

```SQL
CREATE TABLE tbl1
(
    UserID UInt64,
    PageViews UInt8,
    Duration UInt8,
    Sign Int8,
    Version UInt8
)
ENGINE = CollapsingMergeTree(Sign)
ORDER BY UserID;

INSERT INTO tbl1 VALUES (4324182021466249494, 5, 146, -1, 1);
INSERT INTO tbl1 VALUES (4324182021466249494, 5, 146, 1, 1),
                         (4324182021466249494, 6, 185, 1, 2);

SELECT * FROM tbl1;
SELECT * FROM tbl1 FINAL;
```

–ü–æ—è—Å–Ω–µ–Ω–∏–µ:
–í—ã–±—Ä–∞–Ω –¥–≤–∏–∂–æ–∫ __`CollapsingMergeTree`__, —Ç–∞–∫ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–ª–æ–Ω–∫–∞ Sign –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–º –∑–Ω–∞–∫–∞–º.

__–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—ã—à–µ—É–∫–∞–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–º –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —ç—Ç–∞–ø–∞—Ö —Å–µ—Ä–≤–µ—Ä–µ Clickhouse:__

1. –†–µ–∑—É–ª—å—Ç–∞—Ç `SELECT * FROM tbl1;`
![SELECT * FROM tvl1;](https://github.com/realexpert1C/clickhouse-course/blob/823afe56e6b23d5f54bd9ce8576e704f9b89bf7c/images/hw07_VarA_sel.png)


2. –†–µ–∑—É–ª—å—Ç–∞—Ç `SELECT * FROM tbl1 FINAL;`
![SELECT * FROM tvl1 FINAL;](https://github.com/realexpert1C/clickhouse-course/blob/823afe56e6b23d5f54bd9ce8576e704f9b89bf7c/images/hw07_Sel_FINAL.png)

#### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
–í–∏–¥–∏–º, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Å–æ–≤–ø–∞–ª —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –≤ —É—Å–ª–æ–≤–∏—è—Ö –î–ó, –∞ –ø–µ—Ä–≤—ã–π –Ω–µ—Ç. –í —É—Å–ª–æ–≤–∏—è—Ö –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è `SELECT * FROM tbl1;` –ø–æ–∫–∞–∑–∞–ª —Ç–∞–±–ª–∏—Ü—É –∏–∑ —Ç—Ä–µ—Ö —Å—Ç—Ä–æ–∫, –∞ –∑–¥–µ—Å—å –¥–≤–µ. 

–ü–æ—á–µ–º—É –≤ –≤–∞—Ä–∏–∞–Ω—Ç–µ –ê (–º–æ–π) `SELECT * FROM tbl1;` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ 2 —Å—Ç—Ä–æ–∫–∏, —Ö–æ—Ç—è —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –¥–æ–ª–∂–Ω–æ –±—ã–ª–æ –±—ã—Ç—å 3 —Å—Ç—Ä–æ–∫–∏ (–¥–≤–µ —Å Sign = 1 –∏ –æ–¥–Ω–∞ —Å Sign = -1)?

__–í–∞–∂–Ω–∞—è –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏—è CollapsingMergeTree:__
—Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–æ—Ä—è–¥–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ —Å—Ç—Ä–æ–∫ –∏ –æ—Ç —Ç–æ–≥–æ, –≤ –æ–¥–Ω–æ–º INSERT –∏–ª–∏ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã.

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ.

---

‚úÖ 1. –ü–æ—á–µ–º—É —Ç–∞–∫ –≤–∞–∂–Ω–æ –∫–∞–∫ –∏–º–µ–Ω–Ω–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è INSERT?

üìå –ü–µ—Ä–≤—ã–π —Ñ–∞–∫—Ç–æ—Ä - –ü—Ä–∞–≤–∏–ª–æ CollapsingMergeTree

ClickHouse –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–ª–ª–∞–ø—Å —Å—Ç—Ä–æ–∫ (—Å–∫–ª–∞–¥—ã–≤–∞—Ç—å –ø–∞—Ä—ã Sign = -1 –∏ Sign = +1) —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞:
1. —Å—Ç—Ä–æ–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –±–ª–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö
2. —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å ORDER BY

–ß—Ç–æ —Ç–∞–∫–æ–µ ‚Äú–±–ª–æ–∫ –¥–∞–Ω–Ω—ã—Ö‚Äù?
* ClickHouse –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –±–ª–æ–∫ (~65k —Å—Ç—Ä–æ–∫) ‚Äî –∞—Ç–æ–º–∞—Ä–Ω–∞—è –ø–æ—Ä—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö.
* –ï—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–¥–∏–Ω INSERT —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ ‚Äî –æ–Ω–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –æ–¥–∏–Ω –±–ª–æ–∫.
* –ï—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å INSERT –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ ‚Äî –∫–∞–∂–¥—ã–π INSERT —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π –±–ª–æ–∫.

üëâ –ö–æ–ª–ª–∞–ø—Å–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –±–ª–æ–∫–∞.


üìå –í—Ç–æ—Ä–æ–π —Ñ–∞–∫—Ç–æ—Ä - ClickHouse –≤—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –ø–∞—á–∫–∏ –≤ –æ–¥–∏–Ω –º–µ—Ä–∂-–±–ª–æ–∫
–ò —Ç–∞–º —Å—Ç—Ä–æ–∫–∏ —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ ORDER BY UserID, –∞ —É –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ UserID –æ–Ω–∏ —Ç–∞–∫–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ Version

---

üîé 2. –ü–æ–≤–µ–¥–µ–Ω–∏–µ –¥–≤—É—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

üü¢ –í–∞—Ä–∏–∞–Ω—Ç –ê (–æ–¥–∏–Ω –∏–∑ INSERT —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±–µ —Å—Ç—Ä–æ–∫–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º UserID –∏ –≤ –Ω–µ–º –Ω–µ—Ç Sign=-1):

```SQL
INSERT INTO tbl1 VALUES (4324182021466249494, 5,146, -1,1);
```
```SQL
INSERT INTO tbl1 VALUES (4324182021466249494, 5,146, 1,1),
                         (4324182021466249494, 6,185, 1,2);
```
–ü–µ—Ä–≤—ã–π INSERT —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:
- —Å—Ç—Ä–æ–∫–∏ (-1,1)

–í—Ç–æ—Ä–æ–π INSERT —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:
- —Å—Ç—Ä–æ–∫–∏ (+1,1)
- —Å—Ç—Ä–æ–∫–∏ (+1,2)

–≠—Ç–∏ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –æ–¥–∏–Ω –±–ª–æ–∫.

–ù–æ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ (-1,1) ‚Äî –ø–æ–ø–∞–ª–∞ –≤ –±–ª–æ–∫ –¥—Ä—É–≥–æ–≥–æ INSERT, –∑–Ω–∞—á–∏—Ç:
- –æ–Ω–∞ –ù–ï –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ —Å–æ —Å—Ç—Ä–æ–∫–æ–π (+1,1)
- –æ–Ω–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –≤–∏–¥–∏–º–æ–π –≤ SELECT *, –ø–æ–∫–∞ –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç MERGE


‚úî –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–µ–∞–ª—å–Ω–æ:

üîπ –ü–ï–†–í–´–ô INSERT

–°–æ–∑–¥–∞—ë—Ç—Å—è –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞, –æ–¥–∏–Ω –ø–∞—Ä—Ç(–±–ª–æ–∫):

UserID, PageViews=5, Duration=146, Sign = -1, Version=1

üîπ –í–¢–û–†–û–ô INSERT ‚Äî –ø–∞—á–∫–∞ –∏–∑ –¥–≤—É—Ö —Å—Ç—Ä–æ–∫
 
–í–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –±–ª–æ–∫–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç –ø—Ä–∞–≤–∏–ª–æ Collapsing:

Sign	–î–µ–π—Å—Ç–≤–∏–µ

-1	–æ—Ç–º–µ–Ω—è–µ—Ç –ø–æ—Å–ª–µ–¥—É—é—â—É—é +1 –¥–ª—è —Ç–µ—Ö –∂–µ –∫–ª—é—á–µ–π

+1	–¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å

–¢–µ–ø–µ—Ä—å –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–º —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫:

|UserID|PV|Dur|Sign|Ver|
|-------------------|-|---|--|-|
|4324182021466249494|5|146|+1|1|
|4324182021466249494|6|185|+1|2|		

ClickHouse –Ω–µ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ —Ä–∞–∑–Ω—ã–µ –ø–∞—Ä—Ç—ã, –Ω–æ –≤–Ω—É—Ç—Ä–∏ –≤—Ç–æ—Ä–æ–≥–æ –ø–∞—Ä—Ç-–±–ª–æ–∫–∞ –æ–Ω –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏, –∏ —Ç–∞–º –Ω–µ—Ç –ø–∞—Ä—ã (-1, +1) –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö Version.

–ö—Ä–æ–º–µ —ç—Ç–æ–≥–æ, —Å—Ç—Ä–æ–∫–∏ —Å Sign = 1 –∏ Version = 1 –≤ SELECT –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ê –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –æ–Ω–∞ –±—ã–ª–∞ –≤ –æ–¥–Ω–æ–º INSERT-–±–ª–æ–∫–µ –≤–º–µ—Å—Ç–µ —Å Version 2, –∏ ClickHouse –æ—Å—Ç–∞–≤–∏–ª —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é.

–ü–æ—ç—Ç–æ–º—É –∏—Ç–æ–≥–æ–≤—ã–π –Ω–∞–±–æ—Ä —Å—Ç—Ä–æ–∫:

|UserID|PV|Dur|Sign|Ver|
|-------------------|-|---|--|-|
|4324182021466249494|5|146|-1|1|
|4324182021466249494|6|185|+1|2|



–≠—Ç–æ –∫–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ë.

–í –ø–æ–¥—Ç–≤–µ–∂–¥–µ–Ω–∏–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Ç–æ–≤ –≤ —ç—Ç–æ–º –≤–∞—Ä–∏–∞–Ω—Ç–µ:
![–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Ç–æ–≤ –ê](https://github.com/realexpert1C/clickhouse-course/blob/823afe56e6b23d5f54bd9ce8576e704f9b89bf7c/images/hw07_VarA_parts.png)

---

üü¢ –í–∞—Ä–∏–∞–Ω—Ç –ë - —Ç–∞–∫–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç –ø—Ä—è–º–æ –≤ –î–ó –Ω–µ —É–∫–∞–∑–∞–Ω–æ. –ù–æ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã —Å –≤—ã–≤–æ–¥–∞–º–∏ SELECT * FROM tbl1;
—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å–ª–µ–¥—É—é—â–∏–º –≤—Å—Ç–∞–≤–∫–∞–º (–∑–¥–µ—Å—å ‚Äî –¥—Ä—É–≥–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å):

```SQL
INSERT INTO tbl1 VALUES (4324182021466249494, 5,146, -1,1);
```

```SQL
INSERT INTO tbl1 VALUES (4324182021466249494, 5,146, 1,1);
```

```SQL
INSERT INTO tbl1 VALUES (4324182021466249494, 6,185, 1,2);
```

–¢–µ–ø–µ—Ä—å –∫–∞–∂–¥—ã–π INSERT —Å–æ–∑–¥–∞–ª –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫:
* –±–ª–æ–∫ 1: (-1,1)
* –±–ª–æ–∫ 2: (+1,1)
* –±–ª–æ–∫ 3: (+1,2)

üëâ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –ª–µ–∂–∏—Ç –≤ –±–ª–æ–∫–µ, –æ—Ç–ª–∏—á–Ω–æ–º –æ—Ç –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–π.

üëâ –ê –∑–Ω–∞—á–∏—Ç, –∫–æ–ª–ª–∞–ø—Å–∞—Ü–∏–∏ –Ω–µ—Ç (!)

–†–µ–∑—É–ª—å—Ç–∞—Ç:

![–°–µ–ª–µ–∫—Ç –í–∞—Ä–∏–∞–Ω—Ç –ë](https://github.com/realexpert1C/clickhouse-course/blob/823afe56e6b23d5f54bd9ce8576e704f9b89bf7c/images/hw07_VarB_sel.png)

`SELECT * FROM tbl1;` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 3 —Å—Ç—Ä–æ–∫–∏ (–∫–∞–∫ –≤ —É—Å–ª–æ–≤–∏—è—Ö –î–ó)

`SELECT * FROM tbl1 FINAL;` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 1 —Å—Ç—Ä–æ–∫—É:

|UserID|PV|Dur|Sign|Ver|
|-------------------|-|---|--|-|
|4324182021466249494|6|185|+1|2|

FINAL ‚Äú—Å–∫–ª–µ–∏–≤–∞–µ—Ç –±–ª–æ–∫–∏‚Äù –ª–æ–≥–∏—á–µ—Å–∫–∏ ‚Üí –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∫–æ–ª–ª–∞–ø—Å–∞—Ü–∏—é. –ü–æ—ç—Ç–æ–º—É –≤–æ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö –ø—Ä–∏ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö 
 `SELECT * FROM tbl1 FINAL;` –ø–æ–∫–∞–∂–µ—Ç –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
–ü–æ—Å–º–æ—Ç—Ä–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Ç–æ–≤ –≤ –≤–∞—Ä–∏–∞–Ω—Ç–µ –ë:
![–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Ç–æ–≤ –ë](https://github.com/realexpert1C/clickhouse-course/blob/823afe56e6b23d5f54bd9ce8576e704f9b89bf7c/images/hw07_VarB_parts.png)

---
–í –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–º–µ—á—É, —á—Ç–æ –µ—Å–ª–∏ –æ—Å—É—â–µ—Å—Ç–≤–ª—è—Ç—å –≤–µ—Å—å INSERT INTO –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π –¥–ª—è —Ç—Ä–µ—Ö —Å—Ç—Ä–æ–∫ —Å—Ä–∞–∑—É, —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤ –∑–∞–¥–∞—á–µ –¥–∞–Ω–Ω—ã—Ö, —Ç–æ –Ω—É–∂–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å–∫–æ–ª–ª–∞–ø—Å–∏—Ä—É—Ç—Å—è, –µ—Å–ª–∏ –º–æ–∂–Ω–æ —Ç–∞–∫ —Å–∫–∞–∑–∞—Ç—å –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –±–ª–æ–∫–∞ "–Ω–∞ –ª–µ—Ç—É".

–¢–æ –µ—Å—Ç—å –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å—Ç–∞–≤–∫–∏ –≤–æ—Ç —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º:

```SQL
INSERT INTO tbl1 VALUES (4324182021466249494, 5,146, -1,1),
                        (4324182021466249494, 5,146, 1,1),
                        (4324182021466249494, 6,185, 1,2);
```
–º—ã –≤ `SELECT * FROM tbl1;` —É–≤–∏–¥–∏–º –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É, —Ç–∞–∫—É—é –∂–µ –∫–∞–∫ –∏ –≤ `SELECT * FROM tbl1 FINAL;`

![—Ñ–∏–Ω–∞–ª](https://github.com/realexpert1C/clickhouse-course/blob/823afe56e6b23d5f54bd9ce8576e704f9b89bf7c/images/hw07_Sel_FINAL.png)

–∏ –æ–¥–∏–Ω –ø–∞—Ä—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å–≤–µ–Ω–Ω–æ:
![–æ–¥–∏–Ω–ø–∞—Ä—Ç](https://github.com/realexpert1C/clickhouse-course/blob/823afe56e6b23d5f54bd9ce8576e704f9b89bf7c/images/hw07_final_parts.png)

---

üß† –í—ã–≤–æ–¥: –ø–æ—Ä—è–¥–æ–∫ INSERT –Ω–∞–ø—Ä—è–º—É—é –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ ___CollapsingMergeTree__

‚úî –û–¥–∏–Ω INSERT ‚Üí –æ–¥–∏–Ω –±–ª–æ–∫ ‚Üí –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –∫–æ–ª–ª–∞–ø—Å–∞—Ü–∏—è

‚úî –ù–µ—Å–∫–æ–ª—å–∫–æ INSERT ‚Üí –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–ª–æ–∫–æ–≤ ‚Üí –∫–æ–ª–ª–∞–ø—Å–∞—Ü–∏–∏ –¥–æ MERGE –Ω–µ –±—É–¥–µ—Ç

–ê MERGE –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è:
- –≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ñ–æ–Ω–µ
- –Ω–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞–≥—Ä—É–∑–∫–∏, –Ω–∞—Å—Ç—Ä–æ–µ–∫ merge_tree_min_rows, min_bytes –∏ –¥—Ä.

---

üí° –ú–æ–∂–Ω–æ –ª–∏ –≤—Å—Ç–∞–≤–ª—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –æ–¥–Ω–∏–º INSERT?

‚úî –î–∞ ‚Äî –∏ —ç—Ç–æ –¥–∞–∂–µ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è `CollapsingMergeTree`.

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
* –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –æ–¥–∏–Ω –±–ª–æ–∫
* –∫–æ–ª–ª–∞–ø—Å–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–∞ —Å—Ä–∞–∑—É
* –º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ LM-backed storage
* –º–µ–Ω—å—à–µ –º–∞–ª–µ–Ω—å–∫–∏—Ö part-—Ñ–∞–π–ª–æ–≤
* —É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

#### –ó–∞–¥–∞–Ω–∏–µ 2: –¢–∞–±–ª–∏—Ü–∞ tbl2

```SQL
CREATE TABLE tbl2
(
    key UInt32,
    value UInt32
)
ENGINE = SummingMergeTree()
ORDER BY key;

INSERT INTO tbl2 VALUES (1,1), (1,2), (2,1);
SELECT * FROM tbl2;
```

–ü–æ—è—Å–Ω–µ–Ω–∏–µ:
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω __`SummingMergeTree()`__ ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –≤—Å–µ—Ö —á–∏—Å–ª–æ–≤—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤, –Ω–µ –≤—Ö–æ–¥—è—â–∏—Ö –≤ ORDER BY, –¥–ª—è —Å—Ç—Ä–æ–∫ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∫–ª—é—á–æ–º –≤ –º–æ–º–µ–Ω—Ç —Å–ª–∏—è–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–π.

–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ ```SELECT * FROM tbl2;```

![Result SummingMerge]()<!-- –í—Å—Ç–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç  -->

–ò –æ–Ω —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –≤ —É—Å–ª–æ–≤—è–∏—Ö –î–ó.

---

#### –ó–∞–¥–∞–Ω–∏–µ 3: –¢–∞–±–ª–∏—Ü–∞ tbl3

CREATE TABLE tbl3
(
    id Int32,
    status String,
    price String,
    comment String
)
ENGINE = ReplacingMergeTree()
ORDER BY (id, status);

INSERT INTO tbl3 VALUES (23, 'success', '1000', 'Confirmed');
INSERT INTO tbl3 VALUES (23, 'success', '2000', 'Cancelled');

SELECT * FROM tbl3 WHERE id=23;
SELECT * FROM tbl3 FINAL WHERE id=23;

–ü–æ—è—Å–Ω–µ–Ω–∏–µ:
–î–ª—è –∑–∞–º–µ–Ω—ã —Å—Ç—Ä–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ReplacingMergeTree. –ë–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –≤–µ—Ä—Å–∏–∏ ‚Äî –±—É–¥–µ—Ç –≤—ã–±—Ä–∞–Ω–∞ –æ–¥–Ω–∞ –∏–∑ –≤–µ—Ä—Å–∏–π –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ (–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è).

<!-- –í—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã SELECT –∏ SELECT FINAL -->



‚∏ª

#### –ó–∞–¥–∞–Ω–∏–µ 4: –¢–∞–±–ª–∏—Ü–∞ tbl4

CREATE TABLE tbl4
(
    CounterID UInt8,
    StartDate Date,
    UserID UInt64
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(StartDate)
ORDER BY (CounterID, StartDate);

INSERT INTO tbl4 VALUES(0, '2019-11-11', 1);
INSERT INTO tbl4 VALUES(1, '2019-11-12', 1);

–ü–æ—è—Å–Ω–µ–Ω–∏–µ:
–û–±—ã—á–Ω—ã–π MergeTree –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

‚∏ª

#### –ó–∞–¥–∞–Ω–∏–µ 5: –¢–∞–±–ª–∏—Ü–∞ tbl5 (—Å –∞–≥—Ä–µ–≥–∞—Ç–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π)

CREATE TABLE tbl5
(
    CounterID UInt8,
    StartDate Date,
    UserID AggregateFunction(uniq, UInt64)
)
ENGINE = AggregatingMergeTree()
PARTITION BY toYYYYMM(StartDate)
ORDER BY (CounterID, StartDate);

INSERT INTO tbl5
SELECT CounterID, StartDate, uniqState(UserID)
FROM tbl4
GROUP BY CounterID, StartDate;

INSERT INTO tbl5 VALUES (1,'2019-11-12',1);

SELECT uniqMerge(UserID) AS state
FROM tbl5
GROUP BY CounterID, StartDate;

–ü–æ—è—Å–Ω–µ–Ω–∏–µ:
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω AggregatingMergeTree ‚Äî –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–≥—Ä–µ–≥–∞—Ç–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π State, —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ Merge.

<!-- –í—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç SELECT uniqMerge -->



‚∏ª

#### –ó–∞–¥–∞–Ω–∏–µ 6: –¢–∞–±–ª–∏—Ü–∞ tbl6 (–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∑–Ω–∞–∫)

CREATE TABLE tbl6
(
    id Int32,
    status String,
    price String,
    comment String,
    sign Int8
)
ENGINE = CollapsingMergeTree(sign)
ORDER BY (id, status);

INSERT INTO tbl6 VALUES (23, 'success', '1000', 'Confirmed', 1);
INSERT INTO tbl6 VALUES (23, 'success', '1000', 'Confirmed', -1),
                         (23, 'success', '2000', 'Cancelled', 1);

SELECT * FROM tbl6;
SELECT * FROM tbl6 FINAL;

–ü–æ—è—Å–Ω–µ–Ω–∏–µ:
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω CollapsingMergeTree(sign) ‚Äî —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ª–æ–≥–∏–∫—É –æ—Ç–º–µ–Ω—ã/—É–¥–∞–ª–µ–Ω–∏—è –ø–æ –∑–Ω–∞–∫—É. –ü–æ—Å–ª–µ FINAL –æ—Å—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –ø–∞—Ä—ã –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–≥–æ –∑–Ω–∞–∫–∞.

<!-- –í—Å—Ç–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã SELECT –∏ SELECT FINAL -->



‚∏ª

–ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è
	‚Ä¢	–í —Å–ª—É—á–∞–µ —Å ReplacingMergeTree –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ –≤–µ—Ä—Å–∏–∏ ‚Äî –ø–æ—Ä—è–¥–æ–∫ –∑–∞–º–µ–Ω—ã –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω.
	‚Ä¢	–î–ª—è CollapsingMergeTree –≤–∞–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å, —á—Ç–æ FINAL-select –∑–∞—Ç—Ä–∞—Ç–Ω–æ –ø–æ —Ä–µ—Å—É—Ä—Å–∞–º.
	‚Ä¢	–î–ª—è AggregatingMergeTree –≤–∞–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å AggregateFunction-—Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å uniqState, uniqMerge.

‚∏ª

–ò—Å—Ç–æ—á–Ω–∏–∫–∏
	‚Ä¢	[ClickHouse MergeTree Engines](https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/)
	‚Ä¢	TutorialÔøº
	‚Ä¢	AliCloud Engine GuideÔøº

‚∏ª